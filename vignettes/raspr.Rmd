---
title: "raspr: Identify Representative and Adequate Prioritisations in R"
author: "Jeffrey O. Hanson"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---

## Overview
A central aim in conservation is to maximise the long-term persistence of biodiversity. To achieve this, reserve networks must be sited in places that safeguard biodiversity patterns and processes. Here, we present a novel formulation of the reserve-selection problem to identify prioritisations that fulfill this objective. The representative and adequate sample problem (RASP) is a general multi-objective optimisation problem that can identify prioritisations that are adequate--in terms of how much of the feature is secured--and also representative--in terms of the spatial variation at locations where the feature is protected. Here, we present an R package to develop prioritisations using this formulation of the reserve-selection problem. We examine the behaviour of this formulation using several simulated species and a case-study species.

## Problem formulation

## Classes

## Simulated examples
### Data
To investigate the behaviour of the problem, we will use a three simulated species. The first species (termed 'constant') will represent a hyper-generalist. This species will inhabit all areas with equal probability. The second species (termed 'normal') will represent a species with a single range core. The third species (termed 'bimodal') will represent a species with two distinct ecotypes, each with their own range core. To reduce computational time for this example, we will use a $15 \times 15$ grid of square planning units.

```{r, eval=FALSE}
# make planning units
sim_pus <- sim.pus(225L)

# simulate species distributions
sim_spp <- lapply(
	c('constant', 'normal', 'bimodal'),
	sim.species,
  n=1,
  x=sim_pus,
  res=1
)
```

Let's see what these species' distributions look like. Each square represents a planning unit, and the color of each denotes square denotes the probability of the species in the planning unit.

```{r, eval=FALSE}
# change the plot parameters, so we can plot the distributions side by side
par(mfrow=c(1,3))

# constant species
plot(sim_spp[[1]], main='constant species')
lines(sim_pus)

# normal species
plot(sim_spp[[2]], main='normal species')
lines(sim_pus)

# bimodal species
plot(sim_spp[[3]], main='bimodal species')
lines(sim_pus)

# reset plot parameters
par(mfrow=c(1,1))
```

Next, we will generate a set of demand points. To understand the effects of probabilities and weights on the demand points, we will generate the demand points in geographic space. These demand points will be the centroids of the planning units. Additionally, we will use the same set of demand points for each species and only vary the weights of the demand points between species.

```{r, eval=FALSE}
# generate coordinates for pus/demand points
pu_coords <- rgeos::gCentroid(sim_pus, byid=TRUE)

# calculate weights
sim_dps <- lapply(
	sim_spp,
	function(x) {
		return(extract(x, pu_coords))
	}
)

# create demand point objects
sim_dps <- lapply(
	sim_dps,
	function(x) {
		return(
			DemandPoints(
				SimplePoints(pu_coords@coords),
				c(x)
			)
		)
	}
)
```

Now, we will construct a `RaspUnsolved` object which will store all our input data and parameters to generate prioritisations.

```{r, eval=FALSE}
## create RaspOpts object
# this stores parameters for the problem (eg. BLM)
sim_ro <- RaspOpts()

## create GurobiOpts object
# this stores parameters for solving the problem (eg. MIPGap)
sim_go <- GurobiOpts()

## create RaspData object
# create data.frame with species targets
# area targets at 20% and space targets at 0%
spp_targets <- data.frame(
	area.target=rep(0.2, 3),
	space.target=rep(0, 3),
	name=c('constant', 'normal', 'bimodal')
)

# calculate probability of each species in each pu
pu_probabilities <- calcSpeciesAverageInPus(sim_pus, stack(sim_spp))

## create AttributeSpace object
# this stores the coordinates of the planning units in an attribute space
# and the coordinates and weights of demand points in the space
attr_space <- AttributeSpace(
	SimplePoints(pu_coords@coords),
	sim_dps
)

# generate boundary data information
boundary <- calcBoundaryData(sim_pus)

## create RaspData object
# this store all the input data for the prioritisation
sim_rd <- RaspData(
	sim_pus@data,
	spp_targets,
	pu_probabilities,
	list(attr_space),
  boundary,
  SpatialPolygons2PolySet(sim_pus)
)

## create RaspUnsolved object
# this store all the input data and parameters needed to generate prioritisations
sim_ru_area <- RaspUnsolved(sim_ro, sim_go, sim_rd)

```

### Single-species prioritisations
Let's keep things simple to start off with. First, we will generate a set of prioritisations that secure 20% of the species range for minimal cost.

```{r, eval=FALSE}
# make prioritisations for each species using area targets
sp1_area <- solve(spp.subset(sim_ru_area, 'constant'))
sp2_area <- solve(spp.subset(sim_ru_area, 'normal'))
sp3_area <- solve(spp.subset(sim_ru_area, 'bimodal'))

# plot prioritisations
par(mfrow=c(1,3))
plot(sp1_area)
plot(sp2_area)
plot(sp3_area)
par(mfrow=c(1,1))
```

Here, we can see that the prioritisation for the uniform species appears to be random. This is because all planning units have equal probability of occupancy and so any XXX planning units can be preserved to secure 20% of its distribution. The prioritisation for the normal species focusses on the planning units in the species range core. This prioritisation, however, fails  to secure any peripheral parts of the species' distribution. Finally, the prioritisation for the bimodally distributed species only selects planning units in the bottom left corner of the study area. As a consequence, this prioritisation would only preserve individuals from a single eco-type. All of these priotitisations fail to secure a representative portion of the species' geographic distributions because they only prioritise the parts of the species range with the highest occupancy probabilities.

Now, we will generate prioritisations for each species that aim to preserve a rerepresent different parts of the species' geographic distributions explicitly consider their

```{r, eval=FALSE}
# set 20% space targets in sim_ru
sim_ru_space<-update(sim_ru_area, space.targets=0.2)

# make prioritisations for each species
sp1_space <- solve(spp.subset(sim_ru_space, 'constant'))
sp2_space <- solve(spp.subset(sim_ru_space, 'normal'))
sp3_space <- solve(spp.subset(sim_ru_space, 'bimodal'))

# plot prioritisations
par(mfrow=c(1,3))
plot(sp1_space)
plot(sp2_space)
plot(sp3_space)
par(mfrow=c(1,1)))
```

Here, we can see that the prioritisations that explictly consider the space targets do a much better job at preserving different parts of the species' distributions. Before, when only considering area targets, the prioritisation for the constant species was seemingly random. But now, the prioritisation is spread out across the species' distribution. The prioritisaiton for the normal species now captures the core distribution of the species and also parts of its range margin. Lastly, the prioritisation for the bimodally species captures both of eco-types. These results show that the inclusion of space targets in the reserve selection process can significantly change the resulting prioritisation.

### Multi-species prioritisations
Thus far we have generated prioritisations for only one species at a time. However, real-world prioritisations are often generated for multiple-species. Here, we will generate prioritisations for all three of the simulated species. First, we will generate a prioritisation that only aims to preserve 20% of their area they occupy. Then, we will generate a prioritisation that also aims to preserve a representative portion of their geographic distribution. After doing this we will compare the two prioritisations.

```{r, eval=FALSE}
# make prioritisations
sim_mru_area<-solve(sim_ru_area)
sim_mru_space<-solve(sim_ru_space)

# plot prioritisations
plot(sim_mru_area)
plot(sim_mru_space)
```

## Case-study examples
### Data

### Prioritisations
